apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: rkmnodes.rkm.redpoint.games
spec:
  group: rkm.redpoint.games
  scope: Cluster
  names:
    plural: rkmnodes
    singular: rkmnode
    kind: RkmNode
  versions:
  - name: v1
    served: true
    storage: true
    schema:
      openAPIV3Schema:
        type: object
        properties:
          spec:
            type: object
            properties:
              nodeName:
                description: The node name that this machine will use when joining the cluster. Must be set prior if authorized is true.
                type: string
              nodeGroup:
                description: The optional node group that this node should belong to.
                type: string
              authorized:
                description: If true, the node is authorized to join the cluster and will provision based on the node group settings.
                type: boolean
              forceReprovision:
                description: If true, the node will forcibly reprovision the operating system even if it's already provisioned.
                nullable: true
                type: boolean
              inactiveBootEntries:
                description: A list of boot entries that RKM should set to inactive during provisioning. This can be used to disable network boot entries from network adapters that are not attached, speeding up the boot process. Entries not in this list will always be set to active.
                nullable: true
                type: array
                items:
                  type: string
              bootFromNetworkAdapter:
                type: string
                nullable: true
                description: Can be a network adapter name like 'net2'. If set, iPXE will only configure DHCP on this interface. If a machine has multiple physical network adapters, and some of them are not connected, specifying a network adapter name here can improve iPXE boot times by skipping network adapters that will never connect.
              provisionerArguments:
                type: object
                description: An arbitrary map of parameter values that should be available when provisioning. These will override the default parameter values that the provisioner has set. Each entry here will be cause '[[param:<key>]]' to be substituted, and RKM_PARAM_KEY_NAME_TRANSFORMED as an environment variable. KEY_NAME_TRANSFORMED is the key transformed such that 'keyNameTransformed' is 'KEY_NAME_TRANSFORMED'.
                x-kubernetes-preserve-unknown-fields: true
                nullable: true
          status:
            type: object
            properties:
              roles:
                type: array
                description: The roles that this machine has.
                items:
                  type: string
                  enum: [Controller, Worker]
              immutable:
                type: boolean
                description: If true, this machine can't be reprovisioned. This is true if this machine was not provisioned via PXE boot, or if it has the Controller role.
              attestationIdentityKeyFingerprint:
                description: The SHA256 hash of the attestation identity key.
                type: string
              attestationIdentityKeyPem:
                description: The attestation identity key in PEM format, produced by the node's TPM and used to prove this node's identity.
                type: string
              firstSeen:
                type: string
                description: The timestamp that this node first requested to join the cluster.
                format: date-time
              mostRecentJoinRequest:
                type: string
                description: The timestamp that this node last attempted to join the cluster.
                format: date-time
              capablePlatforms:
                type: array
                description: Specifies the platforms that this machine can run.
                items:
                  type: string
                  enum: [Windows, Linux, Mac]
              architecture:
                type: string
                description: Specifies the CPU architecture of this machine.
              provisioner:
                type: object
                nullable: true
                description: The current provisioner state for this node.
                properties:
                  name:
                    type: string
                  hash:
                    type: string
                  lastStepCommittedIndex:
                    type: number
                  rebootStepIndex:
                    type: number
                  rebootNotificationForOnceViaNotifyOccurred:
                    type: boolean
                  currentStepIndex:
                    type: number
                  currentStepStarted:
                    type: boolean
              lastSuccessfulProvision:
                type: object
                nullable: true
                description: Information about the last time this node was successfully provisioned. This is used to automatically detect when the node is out-of-date with the provisioner and trigger a reprovision.
                properties:
                  name:
                    type: string
                  hash:
                    type: string
              registeredIpAddresses:
                type: array
                items:
                  type: object
                  properties:
                    address:
                      type: string
                    expiresAt:
                      type: string
                      format: date-time
              bootToDisk:
                type: boolean
              bootEntries:
                description: The list of boot entries in the EFI firmware, automatically synchronised whenever the initrd starts up. This can be used to then set inactiveBootEntries if needed.
                nullable: true
                type: array
                items:
                  type: object
                  properties:
                    bootId:
                      type: string
                      description: The boot ID; this should be the value set into inactiveBootEntries.
                    name:
                      type: string
                      description: The boot entry name.
                    path:
                      type: string
                      description: The boot entry path.
                    active:
                      type: boolean
                      description: If the entry was active last time the initrd environment ran.
              bootEfiPath:
                type: string
                nullable: true
    selectableFields:
    - jsonPath: .spec.nodeName
    - jsonPath: .spec.nodeGroup
    - jsonPath: .spec.authorized
    additionalPrinterColumns:
    - jsonPath: .spec.nodeName
      name: "Node Name"
      description: The name given to this node if it is authorized. You can't authorize a node without giving it a name.
      type: string
    - jsonPath: .spec.nodeGroup
      name: "Group"
      description: The optional node group for this node to be placed in, which determines 
      type: string
    - jsonPath: .spec.authorized
      name: Authorized
      type: boolean
    - jsonPath: .status.mostRecentJoinRequest
      name: "Most Recent Join Request"
      type: date
