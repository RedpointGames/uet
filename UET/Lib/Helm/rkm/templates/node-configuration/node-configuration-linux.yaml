kind: DaemonSet
apiVersion: apps/v1
metadata:
  name: node-configuration-linux
  namespace: kube-system
  labels:
    app.kubernetes.io/managed-by: {{ .Release.Service | quote }}
    app.kubernetes.io/instance: {{ .Release.Name | quote }}
    app.kubernetes.io/version: {{ .Chart.AppVersion }}
    helm.sh/chart: "{{ .Chart.Name }}-{{ .Chart.Version }}"
    rkm.redpoint.games/component: node-configuration-linux
spec:
  selector:
    matchLabels:
      app.kubernetes.io/instance: {{ .Release.Name | quote }}
      rkm.redpoint.games/component: node-configuration-linux
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
  template:
    metadata:
      labels:
        app.kubernetes.io/managed-by: {{ .Release.Service | quote }}
        app.kubernetes.io/instance: {{ .Release.Name | quote }}
        app.kubernetes.io/version: {{ .Chart.AppVersion }}
        helm.sh/chart: "{{ .Chart.Name }}-{{ .Chart.Version }}"
        rkm.redpoint.games/component: node-configuration-linux
    spec:
      nodeSelector:
        kubernetes.io/os: linux
      hostNetwork: true
      tolerations:
        - effect: NoSchedule
          operator: Exists
        - key: CriticalAddonsOnly
          operator: Exists
        - effect: NoExecute
          operator: Exists
      automountServiceAccountToken: false
      terminationGracePeriodSeconds: 0
      priorityClassName: system-node-critical
      initContainers:
        - name: swap
          image: ubuntu:latest
          command:
            - "/usr/sbin/swapoff"
            - "-a"
          securityContext:
            privileged: true
        - name: bridging
          image: ubuntu:latest
          command:
            - "/bin/bash"
            - "-c"
            - "/usr/sbin/modprobe br_netfilter && /usr/sbin/sysctl net.bridge.bridge-nf-call-iptables=1"
          securityContext:
            privileged: true
          volumeMounts:
            - mountPath: /lib/modules
              name: lib-modules
            - mountPath: /usr/sbin/modprobe
              name: usr-sbin-modprobe
      containers:
        - name: pause
          image: ubuntu:latest
          command:
            - "/bin/bash"
            - "-c"
            - "sleep infinity"
      volumes:
        - name: lib-modules
          hostPath:
            type: DirectoryOrCreate
            path: /lib/modules
        - name: usr-sbin-modprobe
          hostPath:
            type: File
            path: /usr/sbin/modprobe